<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Fleet Master Pro</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        /* ESTILOS GENERALES */
        body { margin: 0; background: #121212; font-family: 'Segoe UI', sans-serif; overflow: hidden; color: white; -webkit-tap-highlight-color: transparent; }
        #map { height: 100vh; width: 100%; z-index: 1; }
        
        /* BOT√ìN DE MEN√ö (Fixed Top-Left) */
        #sidebar-toggle {
            position: fixed; top: 20px; left: 20px; z-index: 3000;
            background: #2962FF; color: white; border: none; border-radius: 12px;
            width: 45px; height: 45px; font-size: 24px; cursor: pointer;
            box-shadow: 0 4px 15px rgba(0,0,0,0.4);
            display: flex; align-items: center; justify-content: center;
            transition: transform 0.2s;
        }
        #sidebar-toggle:hover { transform: scale(1.05); }

        /* --- MEN√ö FLOTANTE (TIPO DROPDOWN) --- */
        .sidebar {
            position: fixed; top: 80px; left: 20px; width: 260px;
            max-height: calc(100vh - 100px); background: rgba(18, 18, 18, 0.95);
            backdrop-filter: blur(15px); border: 1px solid #333;
            border-radius: 16px; z-index: 2000; display: flex; flex-direction: column;
            padding: 15px; gap: 8px; opacity: 0; visibility: hidden;
            transform: translateY(-20px); transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 10px 40px rgba(0,0,0,0.6); overflow-y: auto;
        }
        .sidebar.open { opacity: 1; visibility: visible; transform: translateY(0); }
        .sidebar::-webkit-scrollbar { width: 6px; }
        .sidebar::-webkit-scrollbar-track { background: rgba(255,255,255,0.05); border-radius: 10px; }
        .sidebar::-webkit-scrollbar-thumb { background: #444; border-radius: 10px; }

        /* BOTONES DEL MEN√ö LATERAL */
        .menu-btn {
            width: 100%; min-height: 50px; background: transparent;
            border: 1px solid transparent; color: #eee; border-radius: 8px;
            cursor: pointer; display: flex; align-items: center; padding: 0 15px;
            transition: all 0.2s; flex-shrink: 0;
        }
        .menu-btn:hover { background: rgba(255, 255, 255, 0.05); transform: translateX(5px); }
        .menu-btn.active { background: rgba(41, 98, 255, 0.15); border: 1px solid #2962FF; color: #fff; }
        .menu-btn.manual-active { background: rgba(0, 230, 118, 0.15); border: 1px solid #00E676; color: #00E676; }
        
        .menu-btn .icon { font-size: 22px; width: 40px; text-align: center; margin-right: 10px; }
        .menu-btn .label { font-size: 14px; font-weight: 500; }
        .btn-active-zone { border: 1px solid #C6FF00 !important; background: rgba(198, 255, 0, 0.1) !important; }

        hr { width: 100%; border-color: #333; margin: 10px 0; border-style: solid; border-width: 0 0 1px 0; flex-shrink: 0; }
        
        /* NUEVOS BOTONES FLOTANTES (LAYERS) */
        #floating-layers {
            position: fixed;
            bottom: 200px; /* Encima del cuadro de consumo */
            right: 15px;
            display: flex;
            flex-direction: column;
            gap: 12px;
            z-index: 2999;
        }

        .layer-btn {
            width: 50px; height: 50px;
            border-radius: 50%;
            border: 2px solid #444;
            background: #222;
            color: #aaa;
            font-size: 24px;
            cursor: pointer;
            box-shadow: 0 4px 10px rgba(0,0,0,0.6);
            transition: all 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            display: flex; align-items: center; justify-content: center;
        }

        .layer-btn:hover { transform: scale(1.1); background: #333; }
        
        /* Estados Activos de los Botones Flotantes */
        #btn_clusters.active { border-color: #C6FF00; color: #C6FF00; background: rgba(198, 255, 0, 0.15); box-shadow: 0 0 15px rgba(198, 255, 0, 0.3); }
        #btn_glb.active { border-color: #2962FF; color: #2962FF; background: rgba(41, 98, 255, 0.15); box-shadow: 0 0 15px rgba(41, 98, 255, 0.3); }
        #btn_vip.active { border-color: #FFD700; color: #FFD700; background: rgba(255, 215, 0, 0.15); box-shadow: 0 0 15px rgba(255, 215, 0, 0.3); }

        /* MINI MEN√ö ZONAS */
        .zone-wrapper { position: relative; width: 100%; flex-shrink: 0; }
        .mini-menu { 
            position: absolute; left: 100%; top: 0; margin-left: 10px;
            background: #222; border: 1px solid #555; border-radius: 10px;
            display: none; gap: 5px; padding: 5px; z-index: 2005;
            box-shadow: 0 4px 15px rgba(0,0,0,0.8); animation: fadeIn 0.2s; 
        }
        @keyframes fadeIn { from{opacity:0; transform: translateX(-5px);} to{opacity:1; transform: translateX(0);} }
        .mini-btn { width: 45px; height: 45px; border-radius: 8px; border: none; font-size: 20px; cursor: pointer; color: white; }
        .btn-edit { background: #00E676; color: #000; } .btn-del { background: #D50000; }

        /* UI FLOTANTE */
        #exit-edit-btn { position: fixed; top: 20px; left: 50%; transform: translateX(-50%); background: #D50000; color: white; border: 2px solid white; padding: 10px 25px; border-radius: 30px; font-weight: bold; z-index: 3000; display: none; box-shadow: 0 5px 15px rgba(0,0,0,0.5); }
        #manual-toast { position: fixed; top: 80px; left: 50%; transform: translateX(-50%); background: #00E676; color: black; padding: 8px 20px; border-radius: 20px; font-weight: bold; font-size: 12px; z-index: 2999; display: none; box-shadow: 0 4px 10px rgba(0,230,118,0.4); animation: bounce 0.5s; pointer-events: none;}
        @keyframes bounce { 0%{transform:translate(-50%,-10px);opacity:0;} 50%{transform:translate(-50%,5px);} 100%{transform:translate(-50%,0);opacity:1;} }

        /* DASHBOARD */
        .dashboard-footer { position: fixed; bottom: 20px; left: 0; width: 100%; display: flex; gap: 10px; z-index: 2000; align-items: flex-end; overflow-x: auto; padding: 0 10px; pointer-events: none; }
        .metric-card { background: rgba(20, 20, 20, 0.95); border: 1px solid #444; padding: 10px; border-radius: 10px; min-width: 100px; border-bottom: 4px solid #555; flex-shrink: 0; pointer-events: auto; }
        .card-title { font-size: 10px; font-weight: bold; text-transform: uppercase; margin-bottom: 4px; }
        .metric-value { font-size: 13px; color: #aaa; } .metric-time { font-size: 18px; font-weight: 800; color: #fff; margin-top: 2px; }
        
        #consumption-box { position: fixed; bottom: 130px; right: 10px; background: rgba(0, 50, 0, 0.9); border: 1px solid #00E676; padding: 10px; border-radius: 10px; text-align: right; z-index: 2000; display: none; }
        .cons-label { font-size: 10px; color: #00E676; font-weight: bold; text-transform: uppercase; }
        .cons-val { font-size: 18px; font-weight: 800; color: white; } .cons-unit { font-size: 12px; color: #ccc; }

        /* MODALES */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 9999; display: none; justify-content: center; align-items: center; backdrop-filter: blur(8px); flex-direction: column; }
        .modal-box { background: #222; border: 1px solid #555; border-radius: 15px; padding: 25px; width: 85%; max-width: 350px; text-align: center; }
        .modal-title { font-size: 20px; font-weight: bold; margin-bottom: 15px; color: white; }
        
        .search-modal-box { display: flex; gap: 5px; margin-bottom: 10px; }
        .search-input { flex: 1; padding: 12px; border-radius: 8px; background: #333; border: 1px solid #555; color: white; outline: none; }
        .search-btn { background: #2962FF; border: none; padding: 0 15px; border-radius: 8px; color: white; font-weight: bold; cursor: pointer; }
        
        .veh-options { display: flex; gap: 10px; justify-content: center; flex-wrap: wrap; margin-bottom: 20px; }
        .veh-btn { background: #333; border: 1px solid #555; padding: 15px; border-radius: 10px; cursor: pointer; width: 90px; }
        .veh-btn:hover { background: #00E676; color: black; transform: scale(1.05); }
        .input-group { margin-bottom: 20px; text-align: left; display: none; }
        .custom-input { width: 100%; padding: 12px; background: #111; border: 1px solid #444; color: white; border-radius: 8px; outline: none; margin-bottom: 5px; }
        .presets-container { display: flex; gap: 5px; margin-top: 5px; }
        .preset-btn { flex: 1; padding: 8px; border: 1px solid #444; background: #222; color: #ccc; border-radius: 6px; font-size: 10px; cursor: pointer; }
        
        .btn-primary { background: #2962FF; color: white; padding: 12px; width: 100%; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; }
        .btn-cancel { background: #444; color: white; padding: 12px; width: 100%; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; margin-top: 10px; }
        .btn-confirm-danger { background: #D50000; color: white; padding: 12px; width: 100%; border: none; border-radius: 8px; font-weight: bold; margin-bottom: 10px; cursor: pointer; }

        /* POPUP STYLES */
        .leaflet-popup-content-wrapper { background: #222; color: #fff; } 
        .leaflet-popup-content { margin: 10px; width: 220px !important; text-align: center; }
        .popup-btn { width: 100%; padding: 10px; margin-top: 5px; border: none; border-radius: 5px; font-weight: bold; cursor: pointer; color: white; text-transform: uppercase; font-size: 12px; box-shadow: 0 2px 4px rgba(0,0,0,0.3); }
        
        .btn-check { background: #2E7D32; } .btn-skip { background: #C62828; } .btn-start { background: #00E676; color: black; } .btn-end { background: #FF1744; } .btn-restore { background: #455A64; } .btn-warn { background: #FF9100; color: black; }

        .custom-marker { display: flex; justify-content: center; align-items: center; border-radius: 50%; color: white; font-weight: bold; box-shadow: 0 2px 5px rgba(0,0,0,0.6); border: 2px solid white; }
        .bg-normal { background: #616161; } .bg-start { background: #00E676; border-color: #000; color: #000; } .bg-end { background: #FF1744; border-color: #fff; } .bg-visited { background: #212121; color: #666; opacity: 0.7; } .bg-vip { background: #FFD700; color: black; border-color: #FFC107; }
        .z0 { background: #00B0FF; } .z1 { background: #D500F9; } .z2 { background: #76FF03; color: black; } .z3 { background: #FF9100; color: black; } .z4 { background: #F50057; } .z5 { background: #651FFF; }
        
        .user-gps-marker { width: 20px; height: 20px; background: #2979FF; border: 3px solid white; border-radius: 50%; box-shadow: 0 0 15px #2979FF; animation: pulse 2s infinite; }
        @keyframes pulse { 0% { box-shadow: 0 0 0 0 rgba(41, 121, 255, 0.7); } 100% { box-shadow: 0 0 0 15px transparent; } }
        #loading { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: rgba(41, 98, 255, 0.9); color: white; padding: 15px 30px; border-radius: 10px; font-weight: bold; display: none; z-index: 5000; }
    </style>
</head>
<body>
    <div id="loading">procesando...</div>
    <div id="exit-edit-btn" onclick="stopEditing()">‚ùå TERMINAR EDICI√ìN</div>
    <div id="manual-toast">üëÜ TOCA EL MAPA PARA AGREGAR</div>

    <button id="sidebar-toggle" onclick="toggleSidebar()">‚ò∞</button>

    <div id="floating-layers">
        <button id="btn_clusters" class="layer-btn active" onclick="toggle('rutas')" title="Rutas Locales">üëÅÔ∏è</button>
        <button id="btn_glb" class="layer-btn" onclick="toggle('global')" title="Ruta Global">üåê</button>
        <button id="btn_vip" class="layer-btn" onclick="toggle('vip')" title="Ruta VIP">üëë</button>
    </div>

    <div class="sidebar" id="main-sidebar">
        <div style="font-size:12px; color:#666; font-weight:bold; margin-bottom:5px; padding-left:10px;">ACCIONES</div>
        
        <div class="menu-btn" id="btn_manual" onclick="toggleManualMode()">
            <span class="icon" style="color:#00E676">üëÜ</span><span class="label">Agregar Manual</span>
        </div>

        <div class="menu-btn" onclick="openSearchModal()">
            <span class="icon">üîç</span><span class="label">Buscar Direcci√≥n</span>
        </div>

        <div class="menu-btn" onclick="toggleGPS()">
            <span class="icon" style="color:#2979FF">üìç</span><span class="label">Mi Ubicaci√≥n (GPS)</span>
        </div>
        <div class="menu-btn" onclick="openZoneSelection()"> <span class="icon">üé≤</span><span class="label">Generar Aleatorio</span>
        </div>
        <div class="menu-btn" onclick="cleanRoute()">
            <span class="icon" style="color:#FFA726">üßπ</span><span class="label">Limpiar Mapa</span>
        </div>
        
        <hr>
        <div style="font-size:12px; color:#666; font-weight:bold; margin-bottom:5px; padding-left:10px;">ZONAS & RUTAS</div>

        <div class="menu-btn" onclick="addZone()">
            <span class="icon">‚ûï</span><span class="label">Nueva Zona Manual</span>
        </div>
        <div id="zone_list" style="display:flex; flex-direction:column; gap:4px;"></div>
        </div>

    <div id="zone-selection-modal" class="modal-overlay">
        <div class="modal-box">
            <div class="modal-title">üé≤ ¬øD√≥nde generar?</div>
            <div style="display:flex; gap:10px; justify-content:center; margin-bottom:10px;">
                <button class="veh-btn" onclick="generateRandomZone('neza')">
                    <span style="font-size:24px">üèôÔ∏è</span><br>NEZA
                </button>
                <button class="veh-btn" onclick="generateRandomZone('ipn')">
                    <span style="font-size:24px">üè´</span><br>IPN / LINDA
                </button>
            </div>
            <button class="btn-cancel" onclick="closeZoneSelection()">Cancelar</button>
        </div>
    </div>

    <div id="setup-modal" class="modal-overlay" style="display: flex;">
        <div class="modal-box">
            <div class="modal-title">üöê Configurar Veh√≠culo</div>
            <div id="step-1">
                <div class="veh-options">
                    <div class="veh-btn" onclick="selectType('car')"><span class="veh-icon">üöó</span>Auto</div>
                    <div class="veh-btn" onclick="selectType('moto')"><span class="veh-icon">üèçÔ∏è</span>Moto</div>
                    <div class="veh-btn" onclick="selectType('bike')"><span class="veh-icon">üö≤</span>Bici</div>
                </div>
            </div>
            <div id="step-2" style="display:none;">
                <div class="veh-options">
                    <div class="veh-btn" onclick="selectFuel('fuel')"><span class="veh-icon">‚õΩ</span>F√≥sil</div>
                    <div class="veh-btn" onclick="selectFuel('electric')"><span class="veh-icon">‚ö°</span>El√©ctrico</div>
                </div>
            </div>
            <div id="step-3" style="display:none;">
                <div class="input-group" style="display:block;">
                    <label style="color:#aaa; font-size:12px;">Rendimiento (Km/L):</label>
                    <input type="number" id="consumption-input" class="custom-input" placeholder="Ej: 10">
                </div>
                <div class="input-group" style="display:block;">
                    <label style="color:#aaa; font-size:12px;">Gasto por Encendido:</label>
                    <input type="number" id="stop-cost-input" class="custom-input" placeholder="0.0">
                    <div class="presets-container">
                        <div class="preset-btn" onclick="setPreset(0.005)" style="color:#00E676; border-color:#00E676;">Eco</div>
                        <div class="preset-btn" onclick="setPreset(0.015)" style="color:#FFD700; border-color:#FFD700;">Normal</div>
                        <div class="preset-btn" onclick="setPreset(0.04)" style="color:#FF1744; border-color:#FF1744;">Pesado</div>
                    </div>
                </div>
                <button class="btn-primary" onclick="finishSetup()">üöÄ INICIAR</button>
            </div>
        </div>
    </div>

    <div id="search-modal" class="modal-overlay">
        <div class="modal-box">
            <div class="modal-title">üîç Agregar Parada</div>
            <div class="search-modal-box">
                <input type="text" id="address-input" class="search-input" placeholder="Direcci√≥n..." onkeypress="handleEnter(event)">
                <button class="search-btn" onclick="searchAddress()">IR</button>
            </div>
            <button class="btn-cancel" onclick="closeSearchModal()">Cancelar</button>
        </div>
    </div>

    <div id="consumption-box"><span class="cons-label">Consumo Estimado</span> <span class="cons-val" id="cons-display-val">0.0</span> <span class="cons-unit" id="cons-display-unit">L</span></div>

    <div id="confirm-modal" class="modal-overlay">
        <div class="modal-box">
            <div class="modal-title">‚ö†Ô∏è ¬øFinalizar Ruta?</div>
            <button class="btn-confirm-danger" onclick="executeForceFinish()">S√ç, CERRAR</button>
            <button class="btn-cancel" onclick="closeConfirmModal()">Cancelar</button>
        </div>
    </div>

    <div id="summary-screen" class="modal-overlay">
        <div class="modal-box">
            <div class="modal-title">üìä REPORTE FINAL</div>
            <div class="stat-grid" style="display:grid; grid-template-columns:1fr 1fr; gap:10px; margin-bottom:15px;">
                <div>üì¶ Total: <span id="stat-total">0</span></div>
                <div style="color:#00E676">‚úÖ OK: <span id="stat-ok">0</span></div>
                <div style="color:#FF1744">üö´ Skip: <span id="stat-skip">0</span></div>
                <div style="color:#FF9100">‚ö†Ô∏è Pend: <span id="stat-pend">0</span></div>
            </div>
            <hr style="border-color:#444; margin:15px 0;">
            <div style="font-size:12px; color:#aaa;">Inicio: <span id="stat-cons-initial">0.00</span></div>
            <div style="font-size:18px;">‚õΩ Consumo: <b style="color:#00E676" id="stat-cons-final">0.00</b></div>
            <button class="btn-primary" style="margin-top:20px;" onclick="location.reload()">üîÑ NUEVO</button>
        </div>
    </div>

    <div id="map"></div>
    <div class="dashboard-footer" id="dashboard"></div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet-ant-path@1.3.0/dist/leaflet-ant-path.js"></script>
    
    <script>
        const API = "http://127.0.0.1:8000"; 
        
        // CENTRO INICIAL (PUNTO MEDIO)
        const map = L.map('map', {zoomControl: false}).setView([19.4650, -99.0800], 12);
        L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', { maxZoom: 20 }).addTo(map);

        const layers = { paradas: L.layerGroup().addTo(map), rutas: L.layerGroup().addTo(map), global: L.layerGroup(), vip: L.layerGroup(), gps: L.layerGroup().addTo(map) };
        let activeZone = -1, zoneList = [], openMenuId = -1, gpsWatchId = null, lastData = null;
        let vehicleConfig = { rate: 10, unit: 'L', stopCost: 0.02 };
        let initialSnapshot = { km: 0, stops: 0, captured: false };
        const COLORES = ["#00B0FF", "#D500F9", "#76FF03", "#FF9100", "#F50057", "#651FFF"];

        // --- L√ìGICA MODO MANUAL ---
        let manualMode = false;
        function toggleManualMode() {
            manualMode = !manualMode;
            const btn = document.getElementById('btn_manual');
            const toast = document.getElementById('manual-toast');
            if(manualMode) {
                btn.classList.add('manual-active'); document.getElementById('map').style.cursor = 'crosshair'; toast.style.display = 'block'; toggleSidebar();
            } else {
                btn.classList.remove('manual-active'); document.getElementById('map').style.cursor = ''; toast.style.display = 'none';
            }
        }
        map.on('click', (e) => {
            if (manualMode && confirm("¬øAgregar parada en este punto?")) {
                simular(null, "crear_manual", null, false, null, e.latlng.lat, e.latlng.lng);
            }
        });

        // --- ZONA SELECTION ---
        function openZoneSelection() { document.getElementById('zone-selection-modal').style.display='flex'; toggleSidebar(); }
        function closeZoneSelection() { document.getElementById('zone-selection-modal').style.display='none'; }
        
        function generateRandomZone(zone) {
            closeZoneSelection();
            initialSnapshot.captured = false;
            simular(null, "generar_random", null, true, zone);
        }

        // --- MEN√ö FLOTANTE LOGIC ---
        function toggleSidebar() {
            const sb = document.getElementById('main-sidebar'); sb.classList.toggle('open');
            const btn = document.getElementById('sidebar-toggle');
            if(sb.classList.contains('open')) { btn.innerHTML='‚úï'; btn.style.background='#D32F2F'; }
            else { btn.innerHTML='‚ò∞'; btn.style.background='#2962FF'; }
        }

        // --- GPS ---
        function toggleGPS() {
            if (gpsWatchId) { navigator.geolocation.clearWatch(gpsWatchId); gpsWatchId=null; layers.gps.clearLayers(); alert("GPS Off"); }
            else {
                if (!navigator.geolocation) return alert("No GPS");
                gpsWatchId = navigator.geolocation.watchPosition(
                    (pos) => {
                        const lat = pos.coords.latitude; const lng = pos.coords.longitude;
                        layers.gps.clearLayers();
                        const icon = L.divIcon({className: 'user-gps-marker', iconSize:[20,20]});
                        L.marker([lat, lng], {icon: icon}).addTo(layers.gps);
                        map.panTo([lat, lng]);
                    }, (err) => console.warn(err), { enableHighAccuracy: true }
                );
                alert("GPS Activado");
            }
        }

        // --- WIZARD ---
        function selectType(t) { vehicleConfig.type=t; document.getElementById('step-1').style.display='none'; if(t==='bike'){vehicleConfig.rate=0;finishSetup();return;} document.getElementById(t==='moto'?'step-3':'step-2').style.display='block'; vehicleConfig.unit=t==='moto'?'L':'L'; }
        function selectFuel(f) { vehicleConfig.fuel=f; document.getElementById('step-2').style.display='none'; document.getElementById('step-3').style.display='block'; vehicleConfig.unit=f==='fuel'?'L':'kWh'; }
        function setPreset(v) { document.getElementById('stop-cost-input').value = v; }
        function finishSetup() {
            const r = parseFloat(document.getElementById('consumption-input').value);
            const s = parseFloat(document.getElementById('stop-cost-input').value);
            if(vehicleConfig.type!=='bike') { if(!r||r<=0)return alert("Dato inv√°lido"); vehicleConfig.rate=r; vehicleConfig.stopCost=s||0; }
            document.getElementById('setup-modal').style.display='none';
            if(vehicleConfig.rate>0) document.getElementById('consumption-box').style.display='block';
            document.getElementById('cons-display-unit').innerText=vehicleConfig.unit;
        }

        // --- SEARCH ---
        function openSearchModal(){document.getElementById('search-modal').style.display='flex';}
        function closeSearchModal(){document.getElementById('search-modal').style.display='none';}
        function handleEnter(e){if(e.key==='Enter')searchAddress();}
        async function searchAddress() {
            const q=document.getElementById('address-input').value; if(!q)return;
            document.getElementById("loading").style.display='block';
            try {
                const res = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(q)}`);
                const r = await res.json();
                if(r.length>0) {
                    const {lat, lon, display_name} = r[0]; closeSearchModal(); map.setView([lat, lon], 16);
                    if(confirm(`¬øCrear parada en: ${display_name.substring(0,25)}...?`)) {
                        simular(null, "crear_manual", null, false, null, parseFloat(lat), parseFloat(lon));
                        document.getElementById('address-input').value='';
                    }
                } else alert("No encontrado");
            } catch(e){alert("Error");} finally {document.getElementById("loading").style.display='none';}
        }

        // --- ZONES ---
        window.addZone = () => { if(zoneList.length>=6)return alert("Max 6"); let id=0; while(zoneList.includes(id))id++; zoneList.push(id); startEditing(id); };
        window.toggleMenu = (id) => {
            if(activeZone===id){stopEditing();return;}
            if(openMenuId===id){document.getElementById(`menu-${id}`).style.display='none';openMenuId=-1;}
            else{if(openMenuId!==-1)document.getElementById(`menu-${openMenuId}`).style.display='none';document.getElementById(`menu-${id}`).style.display='flex';openMenuId=id;}
        };
        window.actionEdit = (id) => { document.getElementById(`menu-${id}`).style.display='none'; openMenuId=-1; startEditing(id); };
        window.actionDelete = (id) => { if(!confirm(`¬øBorrar Zona ${id+1}?`))return; zoneList=zoneList.filter(z=>z!==id); if(activeZone===id)stopEditing(); else renderZones(); simular(null, "borrar_zona", id); };
        function startEditing(id) { activeZone=id; document.getElementById('exit-edit-btn').style.display='block'; document.getElementById('exit-edit-btn').innerText=`TERMINAR EDICI√ìN (ZONA ${id+1})`; document.getElementById('exit-edit-btn').style.borderColor=COLORES[id]; renderZones(); if(lastData)renderMap(lastData); }
        window.stopEditing = function() { activeZone=-1; document.getElementById('exit-edit-btn').style.display='none'; renderZones(); if(lastData)renderMap(lastData); }
        function renderZones() {
            const c=document.getElementById('zone_list'); c.innerHTML='';
            zoneList.forEach(id => {
                const w=document.createElement('div'); w.className='zone-wrapper';
                const b=document.createElement('div'); b.className=`menu-btn ${activeZone===id?'btn-active-zone':''}`; b.onclick=()=>toggleMenu(id);
                b.innerHTML=`<span class="icon" style="color:${COLORES[id]}">üì¶</span><span class="label">ZONA ${id+1}</span>`;
                const m=document.createElement('div'); m.id=`menu-${id}`; m.className='mini-menu';
                m.innerHTML=`<button class="mini-btn btn-edit" onclick="actionEdit(${id})">‚úèÔ∏è</button><button class="mini-btn btn-del" onclick="actionDelete(${id})">‚úñÔ∏è</button>`;
                w.appendChild(b); w.appendChild(m); c.appendChild(w);
            });
        }

        // --- COMM (API) ---
        window.simular = async function(aid=null, atip=null, vext=null, reset=false, zone=null, lat=null, lon=null) {
            document.getElementById("loading").style.display='block';
            let url = `${API}/simulacion-leaflet?`;
            if(reset) { url+=`reset=true&`; initialSnapshot.captured=false; }
            if(aid) url+=`accion_id=${aid}&`;
            if(atip) url+=`accion_tipo=${atip}&`;
            if(vext!==null) url+=`valor_extra=${vext}&`;
            
            // LOGICA MULTI-ZONA Y MANUAL
            if(zone) url+=`zona_generacion=${zone}&`; 
            if(lat&&lon) url+=`lat_manual=${lat}&lon_manual=${lon}&`;

            try {
                const res=await fetch(url); if(!res.ok)throw new Error(await res.text());
                const data=await res.json(); lastData=data;
                if(!initialSnapshot.captured && data.ruta_global && data.paradas.length>0) {
                    initialSnapshot.km=parseFloat(data.ruta_global.km); initialSnapshot.stops=data.paradas.length; initialSnapshot.captured=true;
                }
                renderMap(data);
                
                // ZOOM AUTOM√ÅTICO SEG√öN ZONA
                if(zone === 'ipn') map.setView([19.5030, -99.1475], 13);
                if(zone === 'neza') map.setView([19.4938, -99.0478], 13);

            } catch(e){console.error(e); if(reset)alert("Error: "+e.message);} 
            finally{document.getElementById("loading").style.display='none';}
        }

        // --- RENDER ---
        function renderMap(data) {
            Object.values(layers).forEach(l=>{if(l!==layers.gps)l.clearLayers();});
            const hasStart=data.paradas.some(p=>p.tipo==='INICIO'), hasEnd=data.paradas.some(p=>p.tipo==='FIN');
            const pending=data.paradas.filter(p=>p.estado==='PENDIENTE'&&p.tipo!=='FIN').length;
            data.paradas.forEach(p => {
                let vis='NORMAL'; if(p.tipo==='INICIO')vis='INICIO'; else if(p.tipo==='FIN')vis='FIN'; else if(p.estado!=='PENDIENTE')vis=p.estado; else if(p.tipo==='VIP')vis='VIP';
                const ic=createIcon(p.id.replace('P-',''), vis, p.cluster_manual);
                const m=L.marker([p.lat, p.lon], {icon:ic}).addTo(layers.paradas);
                m.on('click', ()=>{ if(activeZone!==-1){const v=(p.cluster_manual===activeZone)?-1:activeZone; simular(p.id,"asignar_zona",v);} });
                bindSmartPopup(m,p,hasStart,hasEnd,pending);
            });
            updateDashboard(data);
        }

        function bindSmartPopup(m,p,hasStart,hasEnd,pend) {
            let h=`<div style="font-weight:bold;margin-bottom:5px;">Punto ${p.id.replace('P-','')}</div>`;
            if(p.cluster_manual!==null)h+=`<div style="font-size:10px;font-weight:bold;color:${COLORES[p.cluster_manual]};">EN ZONA ${p.cluster_manual+1}</div>`;
            h+=`<div style="font-size:12px;color:#aaa;margin-bottom:10px;">${p.estado}</div><div class="popup-actions">`;
            if(activeZone!==-1)h+=`<div style="color:${COLORES[activeZone]};font-weight:bold;">MODO EDICI√ìN</div><div style="font-size:10px;">Toca para asignar</div>`;
            else if(p.tipo==='INICIO'){h+=`<div style="color:#00E676;font-size:11px;">üìç Est√°s aqu√≠</div>`;if(p.tipo!=='FIN')h+=`<button class="popup-btn btn-check" onclick="simular('${p.id}','avanzar_inicio')">üöÄ Siguiente</button>`;}
            else if(p.tipo==='FIN'){if(pend>0){h+=`<div style="color:#FF9100;font-size:11px;margin-bottom:5px;">‚ö†Ô∏è Faltan ${pend}</div>`;h+=`<button class="popup-btn btn-warn" onclick="simular('${p.id}','visitar')">Convertir</button>`;h+=`<button class="popup-btn btn-skip" style="font-size:10px;" onclick="askForceFinish()">Forzar Fin</button>`;}else{h+=`<button class="popup-btn btn-check" onclick="askForceFinish()">Finalizar</button>`;}}
            else if(p.estado==='PENDIENTE'){h+=`<button class="popup-btn btn-check" onclick="simular('${p.id}','visitar')">Ya fui</button>`;h+=`<button class="popup-btn btn-skip" onclick="simular('${p.id}','omitir')">Omitir</button>`;if(!hasStart)h+=`<button class="popup-btn btn-start" style="margin-top:5px" onclick="simular('${p.id}','fijar_inicio')">üö© Inicio</button>`;else if(!hasEnd)h+=`<button class="popup-btn btn-end" style="margin-top:5px" onclick="simular('${p.id}','fijar_fin')">üèÅ Fin</button>`;}
            else{h+=`<button class="popup-btn btn-restore" onclick="simular('${p.id}','restaurar')">Restaurar</button>`;}
            h+=`</div>`; m.bindPopup(h); m.on('popupopen', ()=>{if(activeZone!==-1)m.closePopup();});
        }

        function updateDashboard(d) {
            const db=document.getElementById('dashboard'); db.innerHTML='';
            const add=(l,o,c,t)=>{
                const div=document.createElement('div'); div.className=`metric-card card-${t}`; div.style.borderBottomColor=c;
                const km=o?o.km:0; const ti=o?o.tiempo:'--';
                div.innerHTML=`<div class="card-title" style="color:${c}">${l}</div><div class="metric-value">${km} km</div><div class="metric-time">${ti}</div>`;
                db.appendChild(div);
            };
            add("GLOBAL", d.ruta_global, "#2962FF", "global"); if(d.ruta_global?.coords.length)L.polyline.antPath(d.ruta_global.coords,{color:"#2962FF"}).addTo(layers.global);
            add("VIP", d.ruta_vip, "#FFD700", "vip"); if(d.ruta_vip?.coords.length)L.polyline.antPath(d.ruta_vip.coords,{color:"#FFD700"}).addTo(layers.vip);
            d.rutas_clusters.forEach(r=>{add(`ZONA ${r.cluster_id+1}`,r,r.color,"rutas");if(r.coords.length)L.polyline.antPath(r.coords,{color:r.color}).addTo(layers.rutas);});
            if(vehicleConfig.rate>0&&d.ruta_global){
                const p=d.paradas.filter(x=>x.estado==='PENDIENTE').length;
                const c=calculateCons(parseFloat(d.ruta_global.km), p);
                document.getElementById('cons-display-val').innerText=c.toFixed(2);
            }
            checkVisibility();
        }

        function calculateCons(km,s){if(km<0)km=0;let v=0;if(vehicleConfig.unit==='L')v=(km/vehicleConfig.rate)+(s*vehicleConfig.stopCost);else v=(km*vehicleConfig.rate)+(s*vehicleConfig.stopCost);return v;}
        window.toggle=(n)=>{const i={'rutas':'btn_clusters','global':'btn_glb','vip':'btn_vip'};const e=document.getElementById(i[n]);if(e){e.classList.toggle('active');checkVisibility();}};
        window.checkVisibility=()=>{const i={'rutas':'btn_clusters','global':'btn_glb','vip':'btn_vip'};['global','vip','rutas'].forEach(t=>{const e=document.getElementById(i[t]);const a=e?e.classList.contains('active'):false;if(a){if(!map.hasLayer(layers[t]))map.addLayer(layers[t]);}else map.removeLayer(layers[t]);document.querySelectorAll(`.card-${t}`).forEach(c=>c.style.display=a?'block':'none');});};
        window.createIcon=(l,t,z)=>{let c='bg-normal',s=30;if(t==='INICIO'){c='bg-start';s=36;}else if(t==='FIN'){c='bg-end';s=36;}else if(t==='VISITADO'||t==='OMITIDO'){c='bg-visited';s=26;}else if(z!=null){c=`z${z}`;s=32;}else if(t==='VIP'){c='bg-vip';}return L.divIcon({className:'d',html:`<div class="custom-marker ${c}" style="width:${s}px;height:${s}px;line-height:${s}px">${l}</div>`,iconSize:[s,s],iconAnchor:[s/2,s/2],popupAnchor:[0,-s/2]});};
        window.askForceFinish=()=>{document.getElementById('confirm-modal').style.display='flex';};
        window.closeConfirmModal=()=>{document.getElementById('confirm-modal').style.display='none';};
        window.executeForceFinish=()=>{
            closeConfirmModal(); let t=0,ok=0,s=0,p=0; lastData.paradas.forEach(x=>{t++;if(x.estado==='VISITADO')ok++;else if(x.estado==='OMITIDO')s++;else p++;});
            document.getElementById('stat-total').innerText=t; document.getElementById('stat-ok').innerText=ok; document.getElementById('stat-skip').innerText=s; document.getElementById('stat-pend').innerText=p;
            const u=vehicleConfig.unit; const i=calculateCons(initialSnapshot.km,initialSnapshot.stops).toFixed(2);
            const r=parseFloat(lastData.ruta_global?lastData.ruta_global.km:0); const tr=initialSnapshot.km-r; const f=calculateCons(tr,ok).toFixed(2);
            document.getElementById('stat-cons-initial').innerText=`${i} ${u}`; document.getElementById('stat-cons-final').innerText=`${f} ${u}`;
            Object.values(layers).forEach(l=>{if(l!==layers.gps)l.clearLayers();}); document.getElementById('dashboard').style.display='none'; document.querySelector('.sidebar').style.display='none'; document.getElementById('sidebar-toggle').style.display='none'; document.getElementById('consumption-box').style.display='none'; document.getElementById('summary-screen').style.display='flex';
        };
        window.resetTotal=()=>confirm("¬øReiniciar?")&&location.reload();
        window.cleanRoute=()=>simular(null,"limpiar_ruta");
    </script>
</body>
</html>